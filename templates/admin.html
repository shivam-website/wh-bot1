<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hotel Manager - Orders</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3b82f6;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1f2937;
      --light: #f8fafc;
      --gray: #6b7280;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light);
      color: #333;
      line-height: 1.6;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
    }
    header {
      background: white;
      padding: 15px 20px;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    h1 {
      font-size: 1.5rem;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-gray { background: var(--gray); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    .filters {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--dark);
    }
    select, input {
      padding: 10px 12px;
      border: 1.5px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      min-width: 150px;
    }
    input { flex: 1; min-width: 200px; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    .stat-pending { color: var(--warning); }
    .stat-confirmed { color: var(--primary); }
    .stat-done { color: var(--success); }
    .stat-rejected { color: var(--danger); }
    .stat-label {
      font-size: 0.9rem;
      color: var(--gray);
      font-weight: 600;
    }
    #orderList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 15px;
    }
    .order {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      position: relative;
      animation: fadeIn 0.5s ease;
      border-left: 4px solid transparent;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .order.new { border-left-color: var(--warning); background: #fffbeb; }
    .order.overdue { border-left-color: var(--danger); background: #fef2f2; }
    .order.confirmed { border-left-color: var(--primary); }
    .order.done { border-left-color: var(--success); }
    .order.rejected { border-left-color: var(--danger); }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .room {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--dark);
    }
    .order-id {
      font-size: 0.8rem;
      color: var(--gray);
      background: #f3f4f6;
      padding: 3px 8px;
      border-radius: 20px;
    }
    .order-meta {
      margin-bottom: 15px;
    }
    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
      font-size: 0.95rem;
    }
    .items-list {
      margin: 10px 0;
      padding-left: 20px;
    }
    .items-list li {
      margin-bottom: 5px;
      padding: 5px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .items-list li:last-child {
      border-bottom: none;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .status-Pending { background: #fef3c7; color: #92400e; }
    .status-Confirmed { background: #dbeafe; color: #1e40af; }
    .status-Done { background: #dcfce7; color: #166534; }
    .status-Rejected { background: #fee2e2; color: #991b1b; }
    .order-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    .order-time {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 10px;
      text-align: right;
    }
    .mobile-tabs {
      display: none;
      background: white;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 90;
    }
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      background: #f3f4f6;
      color: var(--gray);
      font-weight: 600;
    }
    .tab-btn.active {
      background: var(--primary);
      color: white;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: white;
      color: var(--dark);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .notification.success { border-left: 4px solid var(--success); }
    .notification.error { border-left: 4px solid var(--danger); }
    .notification.warning { border-left: 4px solid var(--warning); }
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .header-content { flex-direction: column; align-items: center; }
      .controls { justify-content: center; }
      h1 { justify-content: center; }
      .filters { flex-direction: column; align-items: stretch; }
      select, input { min-width: 100%; }
      #orderList { grid-template-columns: 1fr; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .desktop-only { display: none; }
      .mobile-tabs { display: flex; justify-content: space-around; }
    }
    @media (max-width: 480px) {
      .stats { grid-template-columns: 1fr; }
      .btn span.text { display: none; }
      .btn { padding: 10px; }
    }
    .menu-category {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
    }
    .menu-category h4 {
      margin-bottom: 10px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .menu-item-editor {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      align-items: center;
    }
    .menu-item-editor input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .hours-input {
      width: 200px;
      margin-top: 10px;
    }
    .current-menu-display {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .menu-category-display {
      margin-bottom: 15px;
    }
    .menu-category-display h4 {
      color: var(--dark);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .menu-category-display ul {
      list-style: none;
      padding: 0;
    }
    .menu-category-display li {
      padding: 5px 0;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      justify-content: between;
    }
    .menu-category-display li:last-child {
      border-bottom: none;
    }

    /* --- New Login Form & Modal Styles --- */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #e2e8f0;
      flex-direction: column;
      padding: 20px;
    }
    .login-card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .login-card h2 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--dark);
    }
    .login-card p {
      color: var(--gray);
      margin-bottom: 20px;
    }
    .login-form input {
      width: 100%;
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .login-form button {
      width: 100%;
    }
    .error-message {
      color: var(--danger);
      margin-top: 10px;
      font-weight: 600;
    }

    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 2000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
        max-width: 400px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        animation: modal-open 0.3s ease-out;
    }
    .modal-content h3 {
      margin-bottom: 10px;
      color: var(--dark);
    }
    .modal-content p {
      margin-bottom: 20px;
    }
    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    @keyframes modal-open {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    /* --- End New Styles --- */
  </style>
</head>
<body>

  <!-- Login Page -->
  <div id="login-container" class="login-container">
    <div class="login-card">
      <h2><i class="fas fa-lock"></i> Dashboard Login</h2>
      <p>Please enter your credentials to access the manager dashboard.</p>
      <form id="login-form" class="login-form" onsubmit="handleLogin(event)">
        <input type="text" id="username" placeholder="Username" required />
        <input type="password" id="password" placeholder="Password" required />
        <button type="submit" class="btn btn-primary">Login</button>
      </form>
      <div id="login-error" class="error-message" style="display: none;"></div>
    </div>
  </div>

  <!-- Main Dashboard (Initially Hidden) -->
  <div id="dashboard-container" style="display: none;">
    <header>
      <div class="header-content">
        <h1><i class="fas fa-hotel"></i> Hotel Orders Dashboard</h1>
        <div class="controls">
          <button class="btn btn-primary" onclick="exportToCSV()">
            <i class="fas fa-file-export"></i> <span class="text">Export CSV</span>
          </button>
          <button class="btn btn-gray" onclick="removeAllDone()">
            <i class="fas fa-trash"></i> <span class="text">Clear Completed</span>
          </button>
          <button class="btn btn-success" onclick="loadOrders()">
            <i class="fas fa-sync-alt"></i> <span class="text">Refresh</span>
          </button>
          <button class="btn btn-danger" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i> <span class="text">Logout</span>
          </button>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="filters">
        <div class="filter-group">
          <label for="statusFilter">Filter Status</label>
          <select id="statusFilter" onchange="loadOrders()">
            <option value="all">All Orders</option>
            <option value="Pending">Pending</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Done">Done</option>
            <option value="Rejected">Rejected</option>
          </select>
        </div>
        <div class="filter-group" style="flex: 1;">
          <label for="searchInput">Search</label>
          <input type="text" id="searchInput" placeholder="Search by room, items, or guest..." oninput="loadOrders()">
        </div>
        <div class="filter-group">
          <label for="sortBy">Sort By</label>
          <select id="sortBy" onchange="loadOrders()">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="room">Room Number</option>
          </select>
        </div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-number stat-pending" id="count-pending">0</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
          <div class="stat-number stat-confirmed" id="count-confirmed">0</div>
          <div class="stat-label">Confirmed</div>
        </div>
        <div class="stat-card">
          <div class="stat-number stat-done" id="count-done">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-number stat-rejected" id="count-rejected">0</div>
          <div class="stat-label">Rejected</div>
        </div>
      </div>
        <!-- Menu Management Section -->
        <div class="menu-management">
          <h3 style="margin: 20px 0 15px 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-utensils"></i> Menu Management
            <button class="btn btn-sm btn-primary" onclick="toggleMenuEditor()" style="margin-left: auto;">
              <i class="fas fa-edit"></i> Edit Menu
            </button>
          </h3>
      
          <div id="menuEditor" style="display: none; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <div id="menuCategories">
              <!-- Menu categories will be loaded here -->
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
              <button class="btn btn-success" onclick="saveMenu()">
                <i class="fas fa-save"></i> Save Menu
              </button>
              <button class="btn btn-gray" onclick="toggleMenuEditor()">
                <i class="fas fa-times"></i> Cancel
              </button>
            </div>
          </div>
      
          <!-- Current Menu Display -->
          <div id="currentMenu" class="current-menu-display">
            <!-- Current menu will be displayed here -->
          </div>
        </div>

      <div id="orderList">Loading orders...</div>
    </div>

    <div class="mobile-tabs">
      <div class="tab-btn active" onclick="changeTab('all')"><i class="fas fa-list"></i></div>
      <div class="tab-btn" onclick="changeTab('pending')"><i class="fas fa-clock"></i></div>
      <div class="tab-btn" onclick="changeTab('done')"><i class="fas fa-check-circle"></i></div>
      <div class="tab-btn" onclick="changeTab('stats')"><i class="fas fa-chart-bar"></i></div>
    </div>
  </div>
  

  <audio id="notifySound" src="https://assets.mixkit.co/sfx/preview/mixkit-alert-quick-chime-766.mp3" preload="auto"></audio>
  
  <!-- Custom Confirmation Modal -->
  <div id="confirmation-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title"></h3>
      <p id="modal-message"></p>
      <div class="modal-buttons">
        <button id="modal-cancel" class="btn btn-gray">Cancel</button>
        <button id="modal-confirm" class="btn btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // --- Login and Security Logic ---
    const LOGIN_USERNAME = "manager";
    const LOGIN_PASSWORD = "password123";
    const IS_LOGGED_IN_KEY = "isLoggedIn";

    const loginContainer = document.getElementById('login-container');
    const dashboardContainer = document.getElementById('dashboard-container');
    const loginError = document.getElementById('login-error');
    
    // Check if the user is already logged in on page load
    function checkLoginStatus() {
      if (localStorage.getItem(IS_LOGGED_IN_KEY) === 'true') {
        showDashboard();
      } else {
        showLogin();
      }
    }
    
    function showDashboard() {
      loginContainer.style.display = 'none';
      dashboardContainer.style.display = 'block';
      // Load the dashboard data after successful login
      loadOrders();
      loadCurrentMenu();
      setInterval(loadOrders, 10000); // Refresh every 10 seconds
    }
    
    function showLogin() {
      loginContainer.style.display = 'flex';
      dashboardContainer.style.display = 'none';
    }

    function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (username === LOGIN_USERNAME && password === LOGIN_PASSWORD) {
        localStorage.setItem(IS_LOGGED_IN_KEY, 'true');
        showNotification('Login successful!', 'success');
        showDashboard();
      } else {
        loginError.style.display = 'block';
        loginError.textContent = 'Invalid username or password.';
      }
    }
    
    function handleLogout() {
      localStorage.removeItem(IS_LOGGED_IN_KEY);
      showNotification('Logged out successfully.', 'success');
      showLogin();
    }

    // --- Custom Confirmation Modal Logic ---
    const modal = document.getElementById('confirmation-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm');
    const modalCancelBtn = document.getElementById('modal-cancel');

    // Shows the custom confirmation modal
    function showConfirmationModal(title, message, onConfirm) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modal.style.display = 'block';

      modalConfirmBtn.onclick = () => {
        onConfirm();
        modal.style.display = 'none';
      };

      modalCancelBtn.onclick = () => {
        modal.style.display = 'none';
      };
    }

    // --- Original Dashboard Functions (Modified) ---
    let allOrders = [];
    let previousPendingIds = new Set();

    // Show notification function
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'bell'}"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Load orders from server
    async function loadOrders() {
      try {
        const res = await fetch('/api/orders');
        if (!res.ok) throw new Error('Failed to fetch orders');
        allOrders = await res.json();
        renderOrders();
      } catch (err) {
        showNotification('Error loading orders: ' + err.message, 'error');
        console.error(err);
      }
    }

    // Render orders based on filters
    function renderOrders() {
      const filter = document.getElementById('statusFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();
      const sortBy = document.getElementById('sortBy').value;
      
      let filtered = filter === 'all' ? allOrders : allOrders.filter(o => o.status === filter);
      
      if (search) {
        filtered = filtered.filter(o =>
          o.room.toLowerCase().includes(search) ||
          o.items.map(item => item.name).join(' ').toLowerCase().includes(search) ||
          (o.guestNumber && o.guestNumber.toLowerCase().includes(search))
        );
      }
      
      // Sort orders
      switch(sortBy) {
        case 'oldest':
          filtered.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          break;
        case 'room':
          filtered.sort((a, b) => a.room.localeCompare(b.room));
          break;
        default: // newest
          filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      }
      
      // Update statistics
      updateStats();
      
      const container = document.getElementById('orderList');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="no-orders">No orders found matching your criteria</div>';
        return;
      }
      
      container.innerHTML = '';
      filtered.forEach(order => {
        const orderElement = createOrderElement(order);
        container.appendChild(orderElement);
      });
      
      // Check for new pending orders
      const newPendingIds = new Set(allOrders.filter(o => o.status === 'Pending').map(o => o.id));
      const newOrders = [...newPendingIds].filter(id => !previousPendingIds.has(id));
      if (newOrders.length > 0) {
        document.getElementById('notifySound').play().catch(() => {});
        showNotification(`${newOrders.length} new order(s) received!`, 'warning');
      }
      previousPendingIds = newPendingIds;
    }

    // Create order element
    function createOrderElement(order) {
      const div = document.createElement('div');
      div.className = `order ${order.status.toLowerCase()}`;
      
      const minutesAgo = Math.floor((Date.now() - new Date(order.timestamp)) / 60000);
      const isNew = minutesAgo < 5 && order.status === 'Pending';
      const isOverdue = minutesAgo > 15 && order.status === 'Pending';
      
      if (isNew) div.classList.add('new');
      if (isOverdue) div.classList.add('overdue');
      
      div.innerHTML = `
        <div class="order-header">
          <div class="room">Room ${order.room}</div>
          <div class="order-id">#${order.id}</div>
        </div>
        <div class="order-meta">
          <div class="meta-item">
            <i class="fas fa-user"></i>
            <span>${order.guestNumber || 'Guest not specified'}</span>
          </div>
          <div class="meta-item">
            <i class="fas fa-clock"></i>
            <span>${formatTime(new Date(order.timestamp))}</span>
          </div>
        </div>
        <div class="meta-item">
          <i class="fas fa-utensils"></i>
          <span><strong>Order Items:</strong></span>
        </div>
          <ul class="items-list">
            ${order.items.map(item => `<li>• ${item.quantity} x ${item.name}</li>`).join('')}
          </ul>

        <div class="meta-item">
          <i class="fas fa-status"></i>
          <span class="status-badge status-${order.status}">${order.status}</span>
        </div>
        <div class="order-actions">
          ${order.status === 'Pending' ? `
            <button class="btn btn-primary btn-sm" onclick="updateStatus(${order.id}, 'Confirmed')">
              <i class="fas fa-check"></i> Confirm
            </button>
            <button class="btn btn-success btn-sm" onclick="updateStatus(${order.id}, 'Done')">
              <i class="fas fa-check-double"></i> Complete
            </button>
            <button class="btn btn-danger btn-sm" onclick="updateStatus(${order.id}, 'Rejected')">
              <i class="fas fa-times"></i> Reject
            </button>
          ` : order.status === 'Confirmed' ? `
            <button class="btn btn-success btn-sm" onclick="updateStatus(${order.id}, 'Done')">
              <i class="fas fa-check-double"></i> Complete
            </button>
            <button class="btn btn-danger btn-sm" onclick="updateStatus(${order.id}, 'Rejected')">
              <i class="fas fa-times"></i> Reject
            </button>
          ` : ''}
          <button class="btn btn-gray btn-sm" onclick="deleteOrder(${order.id})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="order-time">
          ${formatTimeAgo(new Date(order.timestamp))}
        </div>
      `;
      
      return div;
    }

    // Update order status
    async function updateStatus(id, status) {
      try {
        const res = await fetch(`/api/orders/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        
        if (!res.ok) throw new Error('Failed to update status');
        
        showNotification(`Order #${id} status updated to ${status}`);
        await loadOrders();
      } catch (err) {
        showNotification('Error updating order: ' + err.message, 'error');
      }
    }

    // Delete single order
    async function deleteOrder(id) {
      showConfirmationModal(
        'Delete Order',
        'Are you sure you want to delete this order? This action cannot be undone.',
        async () => {
          try {
            const res = await fetch(`/api/orders/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete order');
            
            showNotification('Order deleted successfully');
            await loadOrders();
          } catch (err) {
            showNotification('Error deleting order: ' + err.message, 'error');
          }
        }
      );
    }

    // Remove all done orders - FIXED
    async function removeAllDone() {
      showConfirmationModal(
        'Clear Completed Orders',
        'Are you sure you want to remove all completed and rejected orders?',
        async () => {
          try {
            // Get all done and rejected orders
            const ordersToDelete = allOrders.filter(order => 
              order.status === 'Done' || order.status === 'Rejected'
            );
            
            // Delete each order individually
            const deletePromises = ordersToDelete.map(order => 
              fetch(`/api/orders/${order.id}`, { method: 'DELETE' })
            );
            
            // Wait for all delete operations to complete
            const results = await Promise.allSettled(deletePromises);
            
            // Check if any deletions failed
            const failedDeletes = results.filter(result => result.status === 'rejected');
            
            if (failedDeletes.length > 0) {
              throw new Error(`Failed to delete ${failedDeletes.length} orders`);
            }
            
            showNotification(`${ordersToDelete.length} completed orders removed successfully`);
            await loadOrders(); // Refresh the order list
          } catch (err) {
            showNotification('Error removing orders: ' + err.message, 'error');
          }
        }
      );
    }
    
    // Alternative implementation if the server supports batch deletion
    async function removeAllDoneAlternative() {
      showConfirmationModal(
        'Clear Completed Orders',
        'Are you sure you want to remove all completed and rejected orders?',
        async () => {
          try {
            const res = await fetch('/api/orders/cleanup', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ statuses: ['Done', 'Rejected'] })
            });
            
            if (!res.ok) {
              // If the cleanup endpoint doesn't exist, try individual deletion
              if (res.status === 404) {
                return await removeAllDone();
              }
              throw new Error('Failed to remove orders');
            }
            
            showNotification('All completed orders removed successfully');
            await loadOrders();
          } catch (err) {
            showNotification('Error removing orders: ' + err.message, 'error');
          }
        }
      );
    }

    // Export to CSV
    function exportToCSV() {
      const rows = [['ID', 'Room', 'Items', 'Guest Number', 'Status', 'Ordered Time']];
      allOrders.forEach(order => {
        const itemsList = order.items.map(item => `${item.quantity}x ${item.name}`).join('; ');
        rows.push([
          order.id,
          order.room,
          itemsList,
          order.guestNumber || 'N/A',
          order.status,
          new Date(order.timestamp).toLocaleString()
        ]);
      });
      
      const csvContent = 'data:text/csv;charset=utf-8,' + rows.map(e => e.join(',')).join('\n');
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `orders_export_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification('CSV export completed');
    }

    // Update statistics
    function updateStats() {
      const counts = {
        Pending: 0,
        Confirmed: 0,
        Done: 0,
        Rejected: 0
      };
      
      allOrders.forEach(order => {
        if (counts.hasOwnProperty(order.status)) {
          counts[order.status]++;
        }
      });
      
      document.getElementById('count-pending').textContent = counts.Pending;
      document.getElementById('count-confirmed').textContent = counts.Confirmed;
      document.getElementById('count-done').textContent = counts.Done;
      document.getElementById('count-rejected').textContent = counts.Rejected;
    }

    // Format time ago
    function formatTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      let interval = seconds / 31536000;
      
      if (interval > 1) return Math.floor(interval) + " years ago";
      interval = seconds / 2592000;
      if (interval > 1) return Math.floor(interval) + " months ago";
      interval = seconds / 86400;
      if (interval > 1) return Math.floor(interval) + " days ago";
      interval = seconds / 3600;
      if (interval > 1) return Math.floor(interval) + " hours ago";
      interval = seconds / 60;
      if (interval > 1) return Math.floor(interval) + " minutes ago";
      return "just now";
    }

    // Format time
    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Mobile tab change
    function changeTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.tab-btn:nth-child(${['all', 'pending', 'done', 'stats'].indexOf(tab) + 1})`).classList.add('active');
      
      switch(tab) {
        case 'pending':
          document.getElementById('statusFilter').value = 'Pending';
          break;
        case 'done':
          document.getElementById('statusFilter').value = 'Done';
          break;
        default:
          document.getElementById('statusFilter').value = 'all';
      }
      
      renderOrders();
    }

    // --- Menu Management Functions (Unchanged) ---
    let currentMenuData = null;

    function toggleMenuEditor() {
      const editor = document.getElementById('menuEditor');
      const display = document.getElementById('currentMenu');
      
      if (editor.style.display === 'none') {
        editor.style.display = 'block';
        display.style.display = 'none';
        loadMenuForEditing();
      } else {
        editor.style.display = 'none';
        display.style.display = 'block';
        loadCurrentMenu();
      }
    }

    async function loadMenuForEditing() {
      try {
        const response = await fetch('/api/menu');
        const menuData = await response.json();
        currentMenuData = menuData;
        
        const categoriesContainer = document.getElementById('menuCategories');
        categoriesContainer.innerHTML = '';
        
        for (const [category, items] of Object.entries(menuData.menu)) {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'menu-category';
          categoryDiv.innerHTML = `
            <h4><i class="fas fa-folder"></i> ${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
            <div class="items-container">
              ${items.map((item, index) => `
                <div class="menu-item-editor">
                  <input type="text" value="${item}" data-category="${category}" data-index="${index}" 
                      placeholder="Item name - Price">
                  <button class="btn btn-danger btn-sm" onclick="removeMenuItem('${category}', ${index})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `).join('')}
            </div>
            <div class="menu-item-editor">
              <input type="text" id="new-${category}" placeholder="New item - Price">
              <button class="btn btn-success btn-sm" onclick="addMenuItem('${category}')">
                <i class="fas fa-plus"></i> Add
              </button>
            </div>
            <div>
              <label>Service Hours:</label>
              <input type="text" class="hours-input" value="${menuData.hours[category]}" 
                      id="hours-${category}" placeholder="e.g., 7:00 AM - 10:30 AM">
            </div>
          `;
          categoriesContainer.appendChild(categoryDiv);
        }
      } catch (error) {
        showNotification('Error loading menu: ' + error.message, 'error');
      }
    }

    function addMenuItem(category) {
      const input = document.getElementById(`new-${category}`);
      const value = input.value.trim();
      
      if (value) {
        currentMenuData.menu[category].push(value);
        
        const categoryDiv = document.querySelector(`.menu-category:has(#new-${category})`);
        const itemsContainer = categoryDiv.querySelector('.items-container');
        
        itemsContainer.innerHTML = currentMenuData.menu[category].map((item, index) => `
          <div class="menu-item-editor">
            <input type="text" value="${item}" data-category="${category}" data-index="${index}" 
                   placeholder="Item name - Price">
            <button class="btn btn-danger btn-sm" onclick="removeMenuItem('${category}', ${index})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `).join('');
        
        input.value = '';
      }
    }

    function removeMenuItem(category, index) {
      currentMenuData.menu[category].splice(index, 1);
      
      const categoryDiv = document.querySelector(`.menu-category:has([data-category="${category}"])`);
      const inputs = categoryDiv.querySelectorAll('input[data-category]');
      
      inputs.forEach((input, newIndex) => {
        input.setAttribute('data-index', newIndex);
      });
      
      const itemsContainer = categoryDiv.querySelector('.items-container');
      itemsContainer.innerHTML = currentMenuData.menu[category].map((item, newIndex) => `
        <div class="menu-item-editor">
          <input type="text" value="${item}" data-category="${category}" data-index="${newIndex}" 
                 placeholder="Item name - Price">
          <button class="btn btn-danger btn-sm" onclick="removeMenuItem('${category}', ${newIndex})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');
    }

    async function saveMenu() {
      try {
        for (const category of Object.keys(currentMenuData.menu)) {
          const hoursInput = document.getElementById(`hours-${category}`);
          if (hoursInput) {
            currentMenuData.hours[category] = hoursInput.value;
          }
        }
        
        const response = await fetch('/api/menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(currentMenuData)
        });
        
        if (response.ok) {
          showNotification('Menu updated successfully!', 'success');
          toggleMenuEditor();
          loadCurrentMenu();
        } else {
          throw new Error('Failed to save menu');
        }
      } catch (error) {
        showNotification('Error saving menu: ' + error.message, 'error');
      }
    }

    async function loadCurrentMenu() {
      try {
        const response = await fetch('/api/menu');
        const menuData = await response.json();
        
        const menuDisplay = document.getElementById('currentMenu');
        menuDisplay.innerHTML = '';
        
        for (const [category, items] of Object.entries(menuData.menu)) {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'menu-category-display';
          categoryDiv.innerHTML = `
            <h4><i class="fas fa-folder"></i> ${category.charAt(0).toUpperCase() + category.slice(1)} 
              <span style="font-size: 0.8em; color: var(--gray); font-weight: normal;">(${menuData.hours[category]})</span>
            </h4>
            <ul>
              ${items.map(item => `<li>• ${item}</li>`).join('')}
            </ul>
          `;
          menuDisplay.appendChild(categoryDiv);
        }
      } catch (error) {
        showNotification('Error loading menu: ' + error.message, 'error');
      }
    }

    // Initialize
    checkLoginStatus();
  </script>
</body>
</html>
